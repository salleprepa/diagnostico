<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Evaluación Diagnóstica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        Chart.defaults.color = '#a3a3a3';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #001a2e;
            color: #e5e7eb;
        }
        .hidden { display: none; }
        .btn-primary {
            background-color: #003356; color: white; font-weight: 600;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color: 0.3s;
            border: 1px solid #004474;
        }
        .btn-primary:hover { background-color: #004474; }
        .btn-danger {
            background-color: #CE0E2D; color: white; font-weight: 600;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color: 0.3s;
            border: 1px solid #a80b24;
        }
        .btn-danger:hover { background-color: #a80b24; }
        .btn-secondary {
            background-color: transparent; color: #e5e7eb;
            font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            transition: all 0.3s; border: 1px solid #003356;
        }
        .btn-secondary:hover { background-color: #003356; color: white; }
        .btn-small {
            padding: 0.25rem 0.5rem; font-size: 0.8rem; border-radius: 0.3rem;
        }
        select, input[type="number"], input[type="text"] {
            background-color: #00223d;
            border-color: #003356;
            color: #e5e7eb;
        }
        select:focus, input:focus {
            --tw-ring-color: #36A2EB;
        }
    </style>
</head>
<body class="bg-[#001a2e]">

    <div id="notification" class="fixed top-5 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl z-50 transition-all duration-300 opacity-0 transform -translate-y-10"></div>

    <div id="dashboard-view" class="bg-[#00223d] p-8 rounded-xl shadow-2xl w-full max-w-screen-2xl mx-auto my-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <div class="flex items-center">
                <img src="https://i.imgur.com/dzDfAiQ.png" alt="Logo La Salle" class="h-16 w-auto mr-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Panel del Maestro</h1>
                    <p class="text-sm text-gray-400 mt-1">Usuario: <span id="user-id"></span></p>
                </div>
            </div>
            <div class="mt-6 md:mt-0 flex flex-wrap items-center gap-4">
                <button id="migrate-data-btn" class="btn-danger">Migrar Datos Antiguos</button>
                <div>
                    <label for="year-selector" class="text-sm font-medium text-gray-300">Año:</label>
                    <select id="year-selector" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 bg-[#00223d] border-gray-600 text-white">
                        <option>2024</option>
                        <option selected>2025</option>
                        <option>2026</option>
                    </select>
                </div>
                <div class="relative">
                    <input type="file" id="csv-file-input" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" accept=".csv">
                    <button id="upload-csv-btn" class="btn-secondary">Cargar CSV</button>
                </div>
                <button id="export-csv-btn" class="btn-secondary">Exportar a CSV</button>
                <button id="show-reports-btn" class="btn-primary">Ver Informes</button>
                <button id="show-students-btn" class="btn-primary hidden">Ver Alumnos</button>
                <a href="index.html" id="student-view-link" class="btn-secondary">Vista Pública</a>
                <button id="logout-btn" class="btn-secondary">Cerrar Sesión</button>
            </div>
        </header>

        <div id="students-view">
            <div class="mb-4 flex justify-between items-center">
                <label for="group-filter-table" class="block text-gray-300 font-semibold">Filtrar por Grupo:</label>
                <select id="group-filter-table" class="w-full sm:w-1/3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2">
                    <option value="">Todos los grupos</option>
                </select>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-lg">
                <table class="min-w-full bg-[#00223d]" id="students-table">
                    <thead style="background-color: #003356;" class="text-white uppercase text-sm">
                        <tr>
                            <th class="py-3 px-4 text-left">Nombre</th>
                            <th class="py-3 px-4 text-left">Edad</th>
                            <th class="py-3 px-4 text-left">Género</th>
                            <th class="py-3 px-4 text-left">Velocidad (50m)</th>
                            <th class="py-3 px-4 text-left">Resistencia</th>
                            <th class="py-3 px-4 text-left">Salto Vertical</th>
                            <th class="py-3 px-4 text-left">Salto Horizontal</th>
                            <th class="py-3 px-4 text-left">Abdominales</th>
                            <th class="py-3 px-4 text-left">Plancha</th>
                            <th class="py-3 px-4 text-left">Flexibilidad</th>
                            <th class="py-3 px-4 text-center">Calificación Final</th>
                            <th class="py-3 px-4 text-left">Observaciones</th>
                            <th class="py-3 px-4 text-left">Informe</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body" class="text-gray-300">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="reports-view" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6">Informes y Análisis</h2>

            <div class="bg-[#001a2e] p-6 rounded-lg mb-6 shadow-inner">
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <div id="report-type-selector" class="flex space-x-2 rounded-lg bg-[#003356] p-1">
                        <button id="global-report-btn" class="px-4 py-2 text-sm font-semibold rounded-md transition-colors text-white">Global</button>
                        <button id="group-report-btn" class="px-4 py-2 text-sm font-semibold rounded-md transition-colors">Por Grupo</button>
                    </div>
                    <div id="report-filters" class="flex flex-wrap items-center gap-4 flex-grow">
                        <div class="flex-grow">
                            <label for="group-filter" class="block text-sm font-medium text-gray-300 mb-1">Grupo:</label>
                            <select id="group-filter" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="flex-grow">
                            <label for="gender-filter" class="block text-sm font-medium text-gray-300 mb-1">Género:</label>
                            <select id="gender-filter" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2">
                                <option value="">Todos</option>
                                <option value="male">Masculino</option>
                                <option value="female">Femenino</option>
                            </select>
                        </div>
                        <button id="apply-filters-btn" class="btn-primary self-end">Aplicar</button>
                    </div>
                    <button id="export-pdf-btn" class="btn-danger self-end">Exportar PDF</button>
                </div>
            </div>
            <div class="bg-[#00223d] p-6 rounded-lg shadow-lg" id="report-content">
                 <div id="overall-stats-section" class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-300">Estadísticas Generales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="bg-[#003356]/50 p-5 rounded-xl border-2 border-blue-800">
                            <p class="text-sm text-gray-400">Total Alumnos</p>
                            <p id="total-students" class="text-3xl font-bold text-blue-300">0</p>
                        </div>
                        <div class="bg-green-900/30 p-5 rounded-xl border-2 border-green-800">
                            <p class="text-sm text-gray-400">Promedio Final</p>
                            <p id="average-final-grade" class="text-3xl font-bold text-green-300">0.00</p>
                        </div>
                        <div class="bg-yellow-900/30 p-5 rounded-xl border-2 border-yellow-800">
                            <p class="text-sm text-gray-400">Necesitan Mejorar</p>
                            <p id="students-need-improvement-count" class="text-3xl font-bold text-yellow-300">0</p>
                        </div>
                    </div>
                </div>
                <div id="report-charts" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-[#001a2e] p-6 rounded-lg shadow-inner relative h-96">
                        <h3 class="text-lg font-semibold mb-3 text-gray-300">Rendimiento Promedio por Prueba</h3>
                        <canvas id="average-scores-chart"></canvas>
                    </div>
                    <div class="bg-[#001a2e] p-6 rounded-lg shadow-inner relative h-96">
                        <h3 class="text-lg font-semibold mb-3 text-gray-300">Distribución de Calificaciones</h3>
                        <canvas id="grade-distribution-chart"></canvas>
                    </div>
                </div>

                <div id="needs-improvement-section" class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-300">Alumnos que Necesitan Apoyo (Calificación < 7)</h3>
                    <div id="needs-improvement-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Student cards will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import Papa from "https://esm.sh/papaparse@5.4.1";

        const LA_SALLE_BLUE = '#003356';
        const __app_id = window.__app_id || 'default-app-id';

        let app, db, auth;
        let currentUserId = null;
        let studentsData = [];
        const testNames = ['Velocidad (50 metros planos)', 'Resistencia', 'Salto Vertical', 'Salto Horizontal', 'Abdominales', 'Plancha', 'Flexibilidad'];
        const unitMap = {
            "Velocidad (50 metros planos)": "s", "Resistencia": "m", "Salto Vertical": "cm",
            "Salto Horizontal": "cm", "Abdominales": "reps", "Plancha": "s", "Flexibilidad": "cm"
        };
        let averageScoresChart, gradeDistributionChart;
        let currentReportType = 'global';

        const GRADING_SCALES = {
            "Velocidad (50 metros planos)": {
                "M": [{ grade: 10, threshold: 7.0, type: "less_than" }, { grade: 9, threshold: 7.4, type: "less_than_or_equal" }, { grade: 8, threshold: 8.0, type: "less_than_or_equal" }, { grade: 7, threshold: 8.5, type: "less_than_or_equal" }],
                "F": [{ grade: 10, threshold: 8.0, type: "less_than" }, { grade: 9, threshold: 8.4, type: "less_than_or_equal" }, { grade: 8, threshold: 9.0, type: "less_than_or_equal" }, { grade: 7, threshold: 9.5, type: "less_than_or_equal" }]
            },
            "Resistencia": {
                "M": [{ grade: 10, threshold: 2000, type: "greater_than_or_equal" }, { grade: 9, threshold: 1800, type: "greater_than_or_equal" }, { grade: 8, threshold: 1500, type: "greater_than_or_equal" }, { grade: 7, threshold: 1200, type: "greater_than_or_equal" }],
                "F": [{ grade: 10, threshold: 1801, type: "greater_than_or_equal" }, { grade: 9, threshold: 1501, type: "greater_than_or_equal" }, { grade: 8, threshold: 1201, type: "greater_than_or_equal" }, { grade: 7, threshold: 1000, type: "greater_than_or_equal" }]
            },
            "Salto Vertical": {
                "M": [{ grade: 10, threshold: 200, type: "greater_than" }, { grade: 9, threshold: 185, type: "greater_than_or_equal" }, { grade: 8, threshold: 170, type: "greater_than_or_equal" }, { grade: 7, threshold: 155, type: "greater_than_or_equal" }],
                "F": [{ grade: 10, threshold: 165, type: "greater_than" }, { grade: 9, threshold: 150, type: "greater_than_or_equal" }, { grade: 8, threshold: 135, type: "greater_than_or_equal" }, { grade: 7, threshold: 120, type: "greater_than_or_equal" }]
            },
            "Salto Horizontal": {
                "M": [{ grade: 10, threshold: 200, type: "greater_than" }, { grade: 9, threshold: 185, type: "greater_than_or_equal" }, { grade: 8, threshold: 170, type: "greater_than_or_equal" }, { grade: 7, threshold: 155, type: "greater_than_or_equal" }],
                "F": [{ grade: 10, threshold: 165, type: "greater_than" }, { grade: 9, threshold: 150, type: "greater_than_or_equal" }, { grade: 8, threshold: 135, type: "greater_than_or_equal" }, { grade: 7, threshold: 120, type: "greater_than_or_equal" }]
            },
            "Abdominales": {
                "M": [{ grade: 10, threshold: 40, type: "greater_than" }, { grade: 9, threshold: 35, type: "greater_than_or_equal" }, { grade: 8, threshold: 30, type: "greater_than_or_equal" }, { grade: 7, threshold: 25, type: "greater_than_or_equal" }],
                "F": [{ grade: 10, threshold: 35, type: "greater_than" }, { grade: 9, threshold: 30, type: "greater_than_or_equal" }, { grade: 8, threshold: 25, type: "greater_than_or_equal" }, { grade: 7, threshold: 20, type: "greater_than_or_equal" }]
            },
            "Plancha": {
                "M": [{ grade: 10, threshold: 90, type: "greater_than" }, { grade: 9, threshold: 75, type: "greater_than_or_equal" }, { grade: 8, threshold: 60, type: "greater_than_or_equal" }, { grade: 7, threshold: 45, type: "greater_than_or_equal" }],
                "F": [{ grade: 10, threshold: 75, type: "greater_than" }, { grade: 9, threshold: 60, type: "greater_than_or_equal" }, { grade: 8, threshold: 45, type: "greater_than_or_equal" }, { grade: 7, threshold: 30, type: "greater_than_or_equal" }]
            },
            "Flexibilidad": {
                "M": [{ grade: 10, threshold: 20, type: "greater_than" }, { grade: 9, threshold: 10, type: "greater_than" }, { grade: 8, threshold: 0, type: "greater_than" }, { grade: 7, threshold: -8, type: "greater_than" }],
                "F": [{ grade: 10, threshold: 25, type: "greater_than" }, { grade: 9, threshold: 15, type: "greater_than" }, { grade: 8, threshold: 5, type: "greater_than" }, { grade: 7, threshold: -5, type: "greater_than" }]
            }
        };

        const calculateTestScore = (testName, gender, result) => {
            if (result === null || result === undefined || result === '') return 0;
            const score = parseFloat(result);
            if (isNaN(score)) return 0;
            const genderKey = gender && gender.trim().toLowerCase().startsWith('m') ? 'M' : 'F';
            const scales = GRADING_SCALES[testName];
            if (!scales) return 0;
            const genderScales = scales[genderKey];
            if (!genderScales) return 0;
            for (const entry of genderScales) {
                if (entry.type === "less_than" && score < entry.threshold) return entry.grade;
                if (entry.type === "less_than_or_equal" && score <= entry.threshold) return entry.grade;
                if (entry.type === "greater_than" && score > entry.threshold) return entry.grade;
                if (entry.type === "greater_than_or_equal" && score >= entry.threshold) return entry.grade;
            }
            return 6;
        };

        const calculateFinalGrade = (scores) => {
            const grades = Object.values(scores).filter(g => g >= 6 && g <= 10);
            if (grades.length === 0) return 0;
            const sum = grades.reduce((acc, current) => acc + current, 0);
            return sum / grades.length;
        };

        const calculateAveragesForSubset = (students) => {
            const averages = {};
            testNames.forEach(test => {
                const scoresForTest = students.map(student => {
                    const result = student.tests?.[test];
                    return calculateTestScore(test, student.gender, result);
                }).filter(score => score > 0);

                if (scoresForTest.length > 0) {
                    const avg = scoresForTest.reduce((sum, score) => sum + score, 0) / scoresForTest.length;
                    averages[test] = avg;
                } else {
                    averages[test] = 0;
                }
            });
            return averages;
        };

        const showNotification = (message, isSuccess = true) => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl z-50 transition-all duration-300 opacity-100 transform translate-y-0 ${isSuccess ? 'bg-green-500' : 'bg-red-500'} text-white`;
            setTimeout(() => {
                notification.className = notification.className.replace('opacity-100 translate-y-0', 'opacity-0 -translate-y-10');
            }, 3000);
        };

        const setupFirebase = async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCIAqDZDZZwWspxNEtzVGd64bSZ0rxO0rs",
                authDomain: "diagnostico-cd701.firebaseapp.com",
                databaseURL: "https://diagnostico-cd701-default-rtdb.firebaseio.com",
                projectId: "diagnostico-cd701",
                storageBucket: "diagnostico-cd701.firebasestorage.app",
                messagingSenderId: "372454029287",
                appId: "1:372454029287:web:ecd8db9ff67dbd961aaf42",
                measurementId: "G-07LZ996EZ5"
            };
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('user-id').textContent = user.email;
                        loadStudents();
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
            }
        };

        const loadStudents = async () => {
            const year = document.getElementById('year-selector').value;
            showNotification(`Cargando datos para el año ${year}...`);

            const studentsRef = collection(db, `/artifacts/${__app_id}/public/data/students`);
            const studentsSnapshot = await getDocs(studentsRef);
            
            const studentPromises = studentsSnapshot.docs.map(async (studentDoc) => {
                const student = { id: studentDoc.id, ...studentDoc.data() };
                
                const resultDocRef = doc(db, `/artifacts/${__app_id}/public/data/students/${student.id}/results/${year}`);
                const resultDoc = await getDoc(resultDocRef);
                
                if (resultDoc.exists()) {
                    const resultData = resultDoc.data();
                    student.tests = resultData.tests || {};
                    student.finalGrade = resultData.finalGrade || 0;
                    student.observation = resultData.observation || '';
                } else {
                    student.tests = {};
                    student.finalGrade = 0;
                    student.observation = '';
                }
                return student;
            });

            studentsData = await Promise.all(studentPromises);
            
            showNotification("Datos cargados.", true);
            renderAll();
        };
        
        const renderAll = () => {
            const groupFilter = document.getElementById('group-filter-table').value;
            const reportGroupFilter = document.getElementById('group-filter').value;
            const reportGenderFilter = document.getElementById('gender-filter').value;
            
            renderStudentsTable({ group: groupFilter });
            populateGroupFilter();
            renderNewReports({ group: reportGroupFilter, gender: reportGenderFilter }, currentReportType);
        }

        const renderStudentsTable = (filters = {}) => {
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = '';
            let filtered = studentsData;
            if (filters.group) filtered = filtered.filter(s => s.group === filters.group);

            filtered.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-[#003356] transition-colors border-b border-gray-700';
                tr.dataset.id = student.id;
                tr.innerHTML = `
                    <td class="py-3 px-4 font-medium text-white">${student.name || 'N/A'}</td>
                    <td class="py-3 px-4">${student.age || 'N/A'}</td>
                    <td class="py-3 px-4">${student.gender || 'N/A'}</td>
                    ${testNames.map(test => `
                        <td class="py-2 px-2">
                            <input type="number" data-test-name="${test}" value="${student.tests?.[test] || ''}" class="w-20 px-2 py-1 border rounded-md text-sm text-center focus:outline-none focus:ring-2">
                        </td>`).join('')}
                    <td class="py-3 px-4 font-bold text-center text-blue-300">${student.finalGrade ? student.finalGrade.toFixed(2) : '-'}</td>
                    <td class="py-3 px-4 text-sm">
                        <span class="block truncate max-w-xs">${student.observation || '-'}</span>
                        <button class="edit-observation-btn btn-secondary btn-small mt-1" data-id="${student.id}">Editar</button>
                    </td>
                    <td class="py-3 px-4">
                        <button class="generate-report-btn btn-primary btn-small" data-id="${student.id}">Generar PDF</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        const populateGroupFilter = () => {
            const groups = [...new Set(studentsData.map(s => s.group).filter(Boolean))].sort();
            ['group-filter-table', 'group-filter'].forEach(id => {
                const select = document.getElementById(id);
                const currentVal = select.value;
                select.innerHTML = `<option value="">Todos</option>`;
                groups.forEach(group => select.innerHTML += `<option value="${group}">${group}</option>`);
                select.value = currentVal;
            });
        };

        const saveStudentScore = async (studentId, testName, value) => {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            const year = document.getElementById('year-selector').value;
            const val = parseFloat(value);
            if (isNaN(val)) {
                showNotification("Por favor, ingrese un número válido.", false);
                return;
            }
            
            const newTests = { ...student.tests, [testName]: val };
            const grades = Object.entries(newTests).reduce((acc, [name, result]) => {
                acc[name] = calculateTestScore(name, student.gender, result);
                return acc;
            }, {});
            const newFinalGrade = calculateFinalGrade(grades);

            const resultDocRef = doc(db, `/artifacts/${__app_id}/public/data/students/${studentId}/results/${year}`);

            try {
                await setDoc(resultDocRef, { tests: newTests, finalGrade: newFinalGrade }, { merge: true });
                showNotification("Calificación actualizada.");
                
                student.tests = newTests;
                student.finalGrade = newFinalGrade;
                renderAll();
            } catch (e) {
                console.error("Error saving score: ", e);
                showNotification("Error al guardar.", false);
            }
        };

        const saveObservation = async (studentId, observationText) => {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            const year = document.getElementById('year-selector').value;
            const resultDocRef = doc(db, `/artifacts/${__app_id}/public/data/students/${studentId}/results/${year}`);

            try {
                await setDoc(resultDocRef, { observation: observationText }, { merge: true });
                showNotification("Observación guardada.");
                student.observation = observationText;
                renderAll();
            } catch (e) {
                console.error("Error saving observation: ", e);
                showNotification("Error al guardar la observación.", false);
            }
        };

        const exportToCsv = () => {
            const groupFilter = document.getElementById('group-filter-table').value;
            let dataToExport = studentsData;
            if (groupFilter) {
                dataToExport = studentsData.filter(s => s.group === groupFilter);
            }

            if (dataToExport.length === 0) {
                showNotification("No hay datos para exportar.", false);
                return;
            }

            const csvData = dataToExport.map(student => {
                const row = {
                    Nombre: student.name,
                    Edad: student.age,
                    Genero: student.gender,
                    Grupo: student.group,
                };
                testNames.forEach(test => {
                    row[test] = student.tests?.[test] || '';
                });
                row['Calificacion Final'] = student.finalGrade ? student.finalGrade.toFixed(2) : '';
                return row;
            });

            const csv = Papa.unparse(csvData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const year = document.getElementById('year-selector').value;
            const groupName = groupFilter ? `_${groupFilter}` : '_todos_los_grupos';
            link.setAttribute('download', `export_alumnos_${year}${groupName}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification("Exportación completada.", true);
        };

        const renderNewReports = (filters = {}, reportType = 'global') => {
            let filtered = studentsData;
            if (filters.group) filtered = filtered.filter(s => s.group === filters.group);
            if (filters.gender) filtered = filtered.filter(s => s.gender && s.gender.toLowerCase() === filters.gender.toLowerCase());

            const total = filtered.length;
            const avgGrade = total > 0 ? filtered.reduce((sum, s) => sum + (s.finalGrade || 0), 0) / total : 0;
            const needsImprovement = filtered.filter(s => (s.finalGrade || 0) < 7);

            document.getElementById('total-students').textContent = total;
            document.getElementById('average-final-grade').textContent = avgGrade.toFixed(2);
            document.getElementById('students-need-improvement-count').textContent = needsImprovement.length;

            const needsImprovementList = document.getElementById('needs-improvement-list');
            needsImprovementList.innerHTML = '';
            if (needsImprovement.length > 0) {
                needsImprovement.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                    const studentCard = `
                        <div class="bg-[#003356]/50 p-4 rounded-lg border border-yellow-700/50">
                            <h4 class="font-semibold text-white">${student.name}</h4>
                            <p class="text-sm text-gray-400">Grupo: ${student.group || 'N/A'}</p>
                            <p class="text-lg font-bold text-yellow-300 mt-2">${(student.finalGrade || 0).toFixed(2)}</p>
                        </div>
                    `;
                    needsImprovementList.innerHTML += studentCard;
                });
            } else {
                needsImprovementList.innerHTML = '<p class="text-gray-400 col-span-full text-center">No hay alumnos en esta categoría.</p>';
            }

            const avgScoresData = testNames.map(test => {
                const scores = filtered.map(s => s.tests?.[test]).filter(s => s != null && !isNaN(s));
                return scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
            });
            const gradeDistData = ['6-7', '7-8', '8-9', '9-10'].map(range => {
                const [min, max] = range.split('-').map(Number);
                return filtered.filter(s => s.finalGrade >= min && s.finalGrade < (max === 10 ? 10.01 : max)).length;
            });

            if (averageScoresChart) averageScoresChart.destroy();
            averageScoresChart = new Chart(document.getElementById('average-scores-chart'), {
                type: 'bar',
                data: { labels: testNames, datasets: [{ label: 'Promedio', data: avgScoresData, backgroundColor: '#003356', borderColor: '#004474', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.2)' } } } }
            });

            if (gradeDistributionChart) gradeDistributionChart.destroy();
            gradeDistributionChart = new Chart(document.getElementById('grade-distribution-chart'), {
                type: 'pie',
                data: { labels: ['6-7', '7-8', '8-9', '9-10'], datasets: [{ data: gradeDistData, backgroundColor: ['#8b0000', '#b22222', '#006400', '#008080'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

        const generateStudentReport = async (studentId) => {
            showNotification("Generando informe...");
            const { jsPDF } = window.jspdf;
            const student = studentsData.find(s => s.id === studentId);
            if (!student) {
                showNotification("Alumno no encontrado.", false);
                return;
            }

            const reportElement = document.createElement('div');
            reportElement.id = 'pdf-template';
            reportElement.style.position = 'absolute';
            reportElement.style.left = '-9999px';
            reportElement.style.width = '210mm';
            reportElement.style.padding = '15mm';
            reportElement.style.backgroundColor = 'white';
            reportElement.style.color = 'black';
            reportElement.style.fontFamily = 'Inter, sans-serif';

            const studentsInSameGroupAndGender = studentsData.filter(s => s.group === student.group && s.gender === student.gender);
            const genderSpecificAverages = calculateAveragesForSubset(studentsInSameGroupAndGender);
            const studentGrades = {};

            let resultsHtml = '';
            testNames.forEach(test => {
                const result = student.tests?.[test];
                const grade = calculateTestScore(test, student.gender, result);
                studentGrades[test] = grade;
                const groupAvg = genderSpecificAverages[test];
                resultsHtml += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">${test}</td>
                        <td style="padding: 8px; text-align: center;">${result !== undefined && result !== '' ? result + (unitMap[test] || '') : 'No realizada'}</td>
                        <td style="padding: 8px; text-align: center;">${groupAvg ? groupAvg.toFixed(1) : '-'}</td>
                        <td style="padding: 8px; text-align: center; font-weight: bold;">${grade > 0 ? grade : '-'}</td>
                    </tr>
                `;
            });

            const year = document.getElementById('year-selector').value;
            const genderLabel = student.gender === 'male' ? 'Masculino' : 'Femenino';

            reportElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #003356; padding-bottom: 10px;">
                    <h1 style="font-size: 24px; font-weight: 700; color: #003356;">Informe de Rendimiento Físico</h1>
                    <img src="https://i.imgur.com/dzDfAiQ.png" alt="Logo" style="height: 60px;">
                </div>
                <div style="margin-top: 20px; font-size: 14px;">
                    <p><strong>Alumno:</strong> ${student.name}</p>
                    <p><strong>Grupo:</strong> ${student.group}</p>
                    <p><strong>Edad:</strong> ${student.age}</p>
                    <p><strong>Género:</strong> ${genderLabel}</p>
                    <p><strong>Año:</strong> ${year}</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 600; color: #003356; margin-bottom: 10px;">Resultados de Pruebas</h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead style="background-color: #f2f2f2;">
                                <tr>
                                    <th style="padding: 8px; text-align: left;">Prueba</th>
                                    <th style="padding: 8px; text-align: center;">Resultado</th>
                                    <th style="padding: 8px; text-align: center;">Prom. Grupo</th>
                                    <th style="padding: 8px; text-align: center;">Calificación</th>
                                </tr>
                            </thead>
                            <tbody>${resultsHtml}</tbody>
                        </table>
                        <p style="text-align: center; font-size: 20px; font-weight: bold; margin-top: 15px;">Calificación Final: <span style="color: #003356;">${student.finalGrade.toFixed(2)}</span></p>
                    </div>
                    <div>
                        <h2 style="font-size: 18px; font-weight: 600; color: #003356; margin-bottom: 10px;">Diagrama de Rendimiento</h2>
                        <canvas id="pdf-chart" width="400" height="300"></canvas>
                        ${student.observation ? `
                            <div style="margin-top: 20px;">
                                <h2 style="font-size: 18px; font-weight: 600; color: #003356; margin-bottom: 10px;">Observaciones</h2>
                                <p style="font-size: 14px; font-style: italic;">“${student.observation}”</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(reportElement);

            const chartCanvas = document.getElementById('pdf-chart');
            new Chart(chartCanvas, {
                type: 'radar',
                data: {
                    labels: testNames,
                    datasets: [{
                        label: 'Calificación Alumno',
                        data: Object.values(studentGrades),
                        backgroundColor: 'rgba(0, 51, 86, 0.2)',
                        borderColor: 'rgba(0, 51, 86, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    animation: {
                        onComplete: () => {
                            html2canvas(reportElement, { scale: 2 }).then(canvas => {
                                const imgData = canvas.toDataURL('image/png');
                                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                                const pdfWidth = pdf.internal.pageSize.getWidth();
                                const pdfHeight = pdf.internal.pageSize.getHeight();
                                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                                pdf.save(`informe_${student.name.replace(/ /g, '_')}_${year}.pdf`);
                                document.body.removeChild(reportElement);
                                showNotification("Informe generado con éxito.", true);
                            });
                        }
                    },
                    scales: { r: { beginAtZero: true, max: 10 } }
                }
            });
        };
        
        const setupEventListeners = () => {
            document.getElementById('export-csv-btn').addEventListener('click', exportToCsv);

            document.getElementById('year-selector').addEventListener('change', () => loadStudents());
            
            document.getElementById('migrate-data-btn').addEventListener('click', async () => {
                if (confirm("Esto moverá los datos de calificaciones existentes al nuevo formato de historial para el año 2025. Esta operación es segura, pero solo debe hacerse una vez. ¿Continuar?")) {
                    await migrateData();
                }
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
                try { await signOut(auth); } catch (error) { console.error("Error al cerrar sesión:", error); }
            });

            document.getElementById('students-table-body').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-observation-btn')) {
                    const studentId = e.target.dataset.id;
                    const student = studentsData.find(s => s.id === studentId);
                    if (student) {
                        const newObservation = prompt("Editar Observación:", student.observation || "");
                        if (newObservation !== null) { 
                            saveObservation(studentId, newObservation);
                        }
                    }
                } else if (e.target.classList.contains('generate-report-btn')) {
                    const studentId = e.target.dataset.id;
                    generateStudentReport(studentId);
                }
            });

            document.getElementById('students-table-body').addEventListener('change', (e) => {
                if (e.target.tagName === 'INPUT') {
                    const row = e.target.closest('tr');
                    saveStudentScore(row.dataset.id, e.target.dataset.testName, e.target.value);
                }
            });
            
            document.getElementById('group-filter-table').addEventListener('change', () => renderAll());
            document.getElementById('apply-filters-btn').addEventListener('click', () => renderAll());

            document.getElementById('show-reports-btn').addEventListener('click', () => {
                document.getElementById('students-view').classList.add('hidden');
                document.getElementById('reports-view').classList.remove('hidden');
                document.getElementById('show-reports-btn').classList.add('hidden');
                document.getElementById('show-students-btn').classList.remove('hidden');
                renderAll(); 
            });

            document.getElementById('show-students-btn').addEventListener('click', () => {
                document.getElementById('reports-view').classList.add('hidden');
                document.getElementById('students-view').classList.remove('hidden');
                document.getElementById('show-students-btn').classList.add('hidden');
                document.getElementById('show-reports-btn').classList.remove('hidden');
            });

        };

        await setupFirebase();
        setupEventListeners();

    </script>

</body>
</html>